<%- include('../partials/header') %>

    <!-- Page Hero -->
    <section class="page-hero">
      <div class="container">
        <p class="eyebrow">Events</p>
        <h1>Join us at our <em>upcoming events</em>.</h1>
        <p class="page-lead">From workshops to fundraisers, there's always something happening at Ella Rises.</p>
        <% if (user && user.role === 'manager') { %>
          <div class="hero-actions">
            <a href="/manage/events" class="btn btn-primary">Manage Events</a>
            <a href="/manage/events/new" class="btn btn-outline">+ Add New Event</a>
          </div>
        <% } %>
      </div>
    </section>

    <!-- Upcoming Events -->
    <section class="section">
      <div class="container">
        <!-- Search Bar -->
        <div class="table-controls">
          <form method="GET" action="/events" class="search-form">
            <input 
              type="text" 
              name="search" 
              placeholder="Search by name, description, type, or location..." 
              value="<%= searchTerm %>"
              class="search-input"
            >
            <button type="submit" class="btn btn-primary">Search</button>
            <% if (searchTerm) { %>
              <a href="/events" class="btn btn-outline">Clear</a>
            <% } %>
          </form>
        </div>

        <div class="section-header">
          <h2>Upcoming Events</h2>
          <p class="text-muted">Join us at these upcoming events and workshops.</p>
        </div>
        <% if (events && events.length > 0) { %>
          <div class="events-list">
            <% events.forEach(event => { 
              const eventDate = event.eventDate ? new Date(event.eventDate) : null;
            %>
              <article class="event-card">
                <div class="event-date">
                  <% if (eventDate) { %>
                    <span class="month"><%= eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase() %></span>
                    <span class="day"><%= eventDate.getDate() %></span>
                    <span class="year"><%= eventDate.getFullYear() %></span>
                  <% } else { %>
                    <span class="month">TBD</span>
                  <% } %>
                </div>
                <div class="event-info">
                  <span class="event-type <%= event.eventType ? event.eventType.toLowerCase().replace(/\s+/g, '-') : '' %>"><%= event.eventType || 'Event' %></span>
                  <h3><%= event.title %></h3>
                  <p><%= event.description %></p>
                  <div class="event-details-row">
                    <% if (event.location) { %><span>üìç <%= event.location %></span><% } %>
                    <% if (eventDate) { %><span>üïê <%= eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) %></span><% } %>
                    <% if (event.capacity) { %>
                      <span>üë• <%= event.registered || 0 %>/<%= event.capacity %> registered
                        <% if (event.isFull) { %>
                          <span class="badge badge-danger" style="margin-left: 8px;">Full</span>
                        <% } %>
                      </span>
                    <% } %>
                  </div>
                </div>
                <div class="event-actions">
                  <% if (user) { %>
                    <% if (event.userHasRSVPd) { %>
                      <button class="btn btn-outline btn-sm cancel-rsvp-btn" data-detail-id="<%= event.detailId %>">Cancel RSVP</button>
                      <span class="badge badge-success" style="margin-left: 8px;">You're Going!</span>
                    <% } else if (event.isFull) { %>
                      <button class="btn btn-outline btn-sm" disabled>Event Full</button>
                    <% } else { %>
                      <% 
                        const deadlinePassed = event.registrationDeadline && new Date(event.registrationDeadline) < new Date();
                      %>
                      <% if (deadlinePassed) { %>
                        <button class="btn btn-outline btn-sm" disabled>Registration Closed</button>
                      <% } else { %>
                        <button class="btn btn-primary btn-sm rsvp-btn" 
                          data-detail-id="<%= event.detailId %>" 
                          data-event-location="<%= event.location || '' %>"
                          data-is-virtual="<%= event.location && event.location.toLowerCase().includes('virtual') ? 'true' : 'false' %>">RSVP</button>
                      <% } %>
                    <% } %>
                  <% } else { %>
                    <a href="/login?redirect=/events" class="btn btn-outline btn-sm">Login to RSVP</a>
                  <% } %>
                  <% if (user && user.role === 'manager') { %>
                    <a href="/manage/events/<%= event.id %>/edit" class="btn btn-outline btn-sm">Edit</a>
                  <% } %>
                </div>
              </article>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>No upcoming events at this time. Check back soon!</p>
          </div>
        <% } %>
      </div>
    </section>

    <!-- Past Events -->
    <section class="section section-alt">
      <div class="container">
        <div class="section-header">
          <h2>Past Events</h2>
          <p class="text-muted">A look back at our recent events and activities.</p>
        </div>
        <% if (pastEvents && pastEvents.length > 0) { %>
          <div class="events-list">
            <% pastEvents.forEach(event => { 
              const eventDate = event.eventDate ? new Date(event.eventDate) : null;
            %>
              <article class="event-card past-event">
                <div class="event-date">
                  <% if (eventDate) { %>
                    <span class="month"><%= eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase() %></span>
                    <span class="day"><%= eventDate.getDate() %></span>
                    <span class="year"><%= eventDate.getFullYear() %></span>
                  <% } else { %>
                    <span class="month">TBD</span>
                  <% } %>
                </div>
                <div class="event-info">
                  <span class="event-type <%= event.eventType ? event.eventType.toLowerCase().replace(/\s+/g, '-') : '' %>"><%= event.eventType || 'Event' %></span>
                  <h3><%= event.title %></h3>
                  <p><%= event.description %></p>
                  <div class="event-details-row">
                    <% if (event.location) { %><span>üìç <%= event.location %></span><% } %>
                    <% if (eventDate) { %><span>üïê <%= eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) %></span><% } %>
                    <% if (event.capacity) { %><span>üë• <%= event.capacity %> spots</span><% } %>
                    <% if (event.recurrence) { %><span>üîÑ <%= event.recurrence %></span><% } %>
                  </div>
                </div>
                <div class="event-actions">
                  <span class="badge badge-secondary">Past Event</span>
                  <% if (user && user.role === 'manager') { %>
                    <a href="/manage/events/<%= event.id %>/edit" class="btn btn-outline btn-sm">Edit</a>
                  <% } %>
                </div>
              </article>
            <% }) %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>No past events to display.</p>
          </div>
        <% } %>
      </div>
    </section>

    <% if (user) { %>
    <!-- RSVP Modal for Physical Events -->
    <div class="modal-overlay" id="rsvp-modal">
      <div class="modal-container">
        <button class="modal-close" id="modal-close-btn">&times;</button>

        <!-- Step 1: Initial Question -->
        <div class="modal-step active" id="step1">
          <h3>How are you getting to the event?</h3>
          <p>This helps us coordinate and make sure everyone can get here safely.</p>
          <div class="modal-actions">
            <button class="btn btn-primary" data-next-step="step-need-ride">I need help finding a ride</button>
            <button class="btn btn-outline" data-next-step="step-have-ride">I already have a ride</button>
          </div>
        </div>

        <!-- Step 2a: Needs a Ride Options -->
        <div class="modal-step" id="step-need-ride">
          <h3>How can we help?</h3>
          <p>Select an option below. We'll do our best to help you get to the event.</p>
          <div class="modal-actions">
            <button class="btn btn-primary" data-next-step="step-rider-address">Request a Carpool Spot</button>
            <button class="btn btn-secondary" data-next-step="step-bus-address">Get Bus Directions</button>
            <button class="btn btn-outline" data-next-step="step1">‚Üê Back</button>
          </div>
        </div>
        
        <!-- Step 3a-1: Rider Address -->
        <div class="modal-step" id="step-rider-address">
          <h3>Enter Your Pickup Address</h3>
          <p class="privacy-warning">For coordination, this address will be shared with your matched driver. Your phone number will also be shared.</p>
          <div class="form-group">
            <label for="rider-address">Your full address</label>
            <input type="text" id="rider-address" placeholder="123 Main St, Anytown, USA" required>
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" data-rsvp-option="carpool-request">Submit Carpool Request</button>
            <button class="btn btn-outline" data-next-step="step-need-ride">‚Üê Back</button>
          </div>
        </div>
        
        <!-- Step 3a-2: Bus Address -->
        <div class="modal-step" id="step-bus-address">
          <h3>Get Public Transit Directions</h3>
          <p>Enter your starting address below. We'll open Google Maps with transit directions for you.</p>
          <div class="form-group">
            <label for="bus-address">Your starting address</label>
            <input type="text" id="bus-address" placeholder="123 Main St, Anytown, USA" required>
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" data-rsvp-option="bus-directions">Show Directions & RSVP</button>
            <button class="btn btn-outline" data-next-step="step-need-ride">‚Üê Back</button>
          </div>
        </div>

        <!-- Step 2b: Has a Ride -->
        <div class="modal-step" id="step-have-ride">
          <h3>That's great!</h3>
          <p>Some of our members need help getting to events. Would you be able to help by offering a ride to others?</p>
          <div class="modal-actions">
            <button class="btn btn-primary" data-next-step="step-can-drive">Yes, I can drive</button>
            <button class="btn btn-outline" data-rsvp-option="no-drive">No, sorry I can't</button>
            <button class="btn btn-outline" data-next-step="step1">‚Üê Back</button>
          </div>
        </div>

        <!-- Step 3b: Driver Details -->
        <div class="modal-step" id="step-can-drive">
          <h3>You're amazing!</h3>
          <p class="privacy-warning">Your address is used for matching and will be kept private. Your phone number will be shared with your matched rider for coordination.</p>
          <div class="form-group">
            <label for="driver-address">Your starting address</label>
            <input type="text" id="driver-address" placeholder="123 Main St, Anytown, USA" required>
          </div>
          <div class="form-group">
            <label for="drive-radius">Willing to travel (miles from your address)</label>
            <input type="number" id="drive-radius" min="1" max="50" value="5" required>
          </div>
          <div class="form-group">
            <label for="seat-count">Number of available seats</label>
            <input type="number" id="seat-count" min="1" max="10" value="1" required>
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" data-rsvp-option="driver-offer">Submit Driver Offer</button>
            <button class="btn btn-outline" data-next-step="step-have-ride">‚Üê Back</button>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="modal-step" id="step-confirmation">
          <h3>Thank You!</h3>
          <p id="confirmation-message"></p>
          <div class="modal-actions">
            <button class="btn btn-primary" id="modal-close-confirm-btn">Close</button>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <script>
      <% if (user) { %>
      // RSVP Modal functionality
      document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('rsvp-modal');
        if (!modal) return;

        const closeBtn = document.getElementById('modal-close-btn');
        const closeConfirmBtn = document.getElementById('modal-close-confirm-btn');
        const steps = modal.querySelectorAll('.modal-step');
        const confirmationMessage = document.getElementById('confirmation-message');
        let currentEventDetailId = null;
        let currentEventLocation = '';

        function goToStep(stepId) {
          steps.forEach(step => step.classList.remove('active'));
          const nextStep = document.getElementById(stepId);
          if (nextStep) nextStep.classList.add('active');
        }

        function showModal(detailId, eventLocation, isVirtual) {
          currentEventDetailId = detailId;
          currentEventLocation = eventLocation || '';
          
          if (isVirtual === 'true') {
            // Handle virtual event directly
            submitRsvp({ option: 'virtual' }, detailId).then(result => {
              alert(result.message);
              window.location.reload();
            });
            return;
          }

          modal.classList.add('show');
          goToStep('step1');
          // Reset all form inputs
          const inputs = modal.querySelectorAll('input[type="text"], input[type="number"]');
          inputs.forEach(input => {
            input.value = '';
            if (input.type === 'number' && input.hasAttribute('value')) {
              input.value = input.getAttribute('value');
            }
          });
        }

        function hideModal() {
          modal.classList.remove('show');
          currentEventDetailId = null;
          currentEventLocation = '';
        }

        async function submitRsvp(data, detailId) {
          try {
            const response = await fetch(`/events/${detailId || currentEventDetailId}/rsvp`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Network response was not ok');
            }
            return await response.json();
          } catch (error) {
            console.error('RSVP Submission Error:', error);
            return { success: false, message: error.message || 'Sorry, there was an error submitting your RSVP. Please try again later.' };
          }
        }

        // Handle RSVP button clicks
        document.querySelectorAll('.rsvp-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const detailId = this.getAttribute('data-detail-id');
            const eventLocation = this.getAttribute('data-event-location') || '';
            const isVirtual = this.getAttribute('data-is-virtual') || 'false';
            showModal(detailId, eventLocation, isVirtual);
          });
        });

        closeBtn.addEventListener('click', hideModal);
        closeConfirmBtn.addEventListener('click', () => {
          hideModal();
          window.location.reload(); // Reload to update RSVP status
        });
        
        // Close modal when clicking overlay
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            hideModal();
          }
        });

        // Handle button clicks inside modal
        modal.addEventListener('click', (e) => {
          const target = e.target.closest('button');
          if (!target) return;

          // Prevent event bubbling
          e.stopPropagation();

          if (target.matches('[data-next-step]')) {
            e.preventDefault();
            goToStep(target.getAttribute('data-next-step'));
            return;
          }

          if (target.matches('[data-rsvp-option]')) {
            e.preventDefault();
            const option = target.getAttribute('data-rsvp-option');
            let rsvpData = { option };

            if (!currentEventDetailId) {
              alert('Error: Event ID is missing. Please refresh the page.');
              return;
            }

            if (option === 'carpool-request') {
              const address = document.getElementById('rider-address').value;
              if (!address) { alert('Please enter your address.'); return; }
              rsvpData.address = address;
              submitRsvp(rsvpData, currentEventDetailId).then(result => {
                if (result.success) {
                  confirmationMessage.textContent = result.message;
                  goToStep('step-confirmation');
                } else {
                  alert('Error: ' + result.message);
                }
              });
            } else if (option === 'driver-offer') {
              const address = document.getElementById('driver-address').value;
              const radius = document.getElementById('drive-radius').value;
              const seats = document.getElementById('seat-count').value;
              if (!address || !radius || !seats) { alert('Please fill out all fields.'); return; }
              rsvpData.address = address;
              rsvpData.radius = radius;
              rsvpData.seatCount = seats;
              submitRsvp(rsvpData, currentEventDetailId).then(result => {
                if (result.success) {
                  confirmationMessage.textContent = result.message;
                  goToStep('step-confirmation');
                } else {
                  alert('Error: ' + result.message);
                }
              });
            } else if (option === 'bus-directions') {
                const startAddress = document.getElementById('bus-address').value;
                if (!startAddress) { alert('Please enter a starting address.'); return; }
                if (!currentEventLocation || currentEventLocation.trim() === '') {
                    alert('Error: Event destination address is missing. Cannot provide directions.');
                    return;
                }
                const destination = encodeURIComponent(currentEventLocation);
                const origin = encodeURIComponent(startAddress);
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=transit`;
                window.open(mapsUrl, '_blank');
                rsvpData.option = 'bus';
                rsvpData.address = startAddress;
                submitRsvp(rsvpData, currentEventDetailId).then(result => {
                  if (result.success) {
                    confirmationMessage.textContent = result.message;
                    goToStep('step-confirmation');
                  } else {
                    alert('Error: ' + result.message);
                  }
                });
            } else { // Handles 'no-drive' and other simple RSVPs
              submitRsvp(rsvpData, currentEventDetailId).then(result => {
                if (result.success) {
                  confirmationMessage.textContent = result.message;
                  goToStep('step-confirmation');
                } else {
                  alert('Error: ' + result.message);
                }
              });
            }
          }
        });

        // Initialize: hide modal and show only first step
        hideModal();
        goToStep('step1');
      });
      <% } %>

      // Handle Cancel RSVP button clicks
      document.querySelectorAll('.cancel-rsvp-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const detailId = this.getAttribute('data-detail-id');
          
          if (!confirm('Are you sure you want to cancel your RSVP?')) {
            return;
          }

          const originalText = this.textContent;
          this.disabled = true;
          this.textContent = 'Cancelling...';

          try {
            const response = await fetch(`/events/${detailId}/rsvp`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });

            const result = await response.json();

            if (result.success) {
              alert(result.message);
              window.location.reload(); // Reload to update counts and status
            } else {
              alert('Error: ' + result.message);
              this.disabled = false;
              this.textContent = originalText;
            }
          } catch (error) {
            alert('Error: ' + error.message);
            this.disabled = false;
            this.textContent = originalText;
          }
        });
      });
    </script>

<%- include('../partials/footer') %>


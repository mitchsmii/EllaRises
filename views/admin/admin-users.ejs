<%- include('../partials/header') %>

    <!-- Page Hero -->
    <section class="page-hero compact">
      <div class="container">
        <p class="eyebrow">Admin</p>
        <h1>User <em>Management</em></h1>
        <p class="page-lead">Manage user account and permissions.</p>
        <div class="hero-actions">
          <a href="/admin/users/new" class="btn btn-primary">+ Add User</a>
        </div>
      </div>
    </section>

    <!-- Users Table -->
    <section class="section">
      <div class="container">
        <% if (typeof message !== 'undefined' && message) { %>
          <div class="alert alert-<%= typeof messageType !== 'undefined' && messageType === 'success' ? 'success' : 'error' %>" style="margin-bottom: var(--space-xl);">
            <%= message %>
          </div>
        <% } %>

        <!-- Search and Stats -->
        <div class="table-controls">
          <form method="GET" action="/admin/users" class="search-form">
            <input 
              type="text" 
              name="search" 
              placeholder="Search by name or email..." 
              value="<%= search || '' %>"
              class="search-input"
            >
            <button type="submit" class="btn btn-primary">Search</button>
            <% if (search) { %>
              <a href="/admin/users" class="btn btn-outline">Clear</a>
            <% } %>
          </form>
          <div class="table-stats">
            Showing <%= users.length > 0 ? ((currentPageNum - 1) * 20 + 1) : 0 %>-<%= Math.min(currentPageNum * 20, totalUsers) %> of <%= totalUsers %> users
          </div>
        </div>

        <% if (users && users.length > 0) { %>
          <div class="data-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Person ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(u => { %>
                  <tr>
                    <td>
                      <div class="user-cell">
                        <div class="avatar-placeholder"><%= (u.firstName || 'N').charAt(0) %><%= (u.lastName || 'A').charAt(0) %></div>
                        <strong><%= u.firstName %> <%= u.lastName %></strong>
                      </div>
                    </td>
                    <td><%= u.email %></td>
                    <td>
                      <span class="role-badge <%= u.role === 'manager' || u.role === 'admin' ? 'manager' : 'user' %>">
                        <%= u.role === 'admin' ? 'manager' : u.role %>
                      </span>
                    </td>
                    <td><%= u.personId || 'N/A' %></td>
                    <td>
                      <div class="action-buttons">
                        <a href="/admin/users/<%= encodeURIComponent(u.email) %>/edit" class="btn btn-sm btn-outline">Edit</a>
                        <% if (u.email !== user.email) { %>
                          <button class="btn btn-sm btn-danger delete-user-btn" data-email="<%= u.email %>" data-name="<%= u.firstName %> <%= u.lastName %>">Delete</button>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <div class="pagination">
              <% if (hasPrevPage) { %>
                <a href="/admin/users?page=<%= currentPageNum - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" class="pagination-btn">← Previous</a>
              <% } else { %>
                <span class="pagination-btn disabled">← Previous</span>
              <% } %>
              
              <div class="pagination-pages">
                <% 
                  let startPage = Math.max(1, currentPageNum - 2);
                  let endPage = Math.min(totalPages, currentPageNum + 2);
                  
                  if (startPage > 1) { %>
                    <a href="/admin/users?page=1<%= search ? '&search=' + encodeURIComponent(search) : '' %>" class="pagination-number">1</a>
                    <% if (startPage > 2) { %>
                      <span class="pagination-ellipsis">...</span>
                    <% } %>
                  <% }
                  
                  for (let i = startPage; i <= endPage; i++) { %>
                    <% if (i === currentPageNum) { %>
                      <span class="pagination-number active"><%= i %></span>
                    <% } else { %>
                      <a href="/admin/users?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" class="pagination-number"><%= i %></a>
                    <% } %>
                  <% }
                  
                  if (endPage < totalPages) { %>
                    <% if (endPage < totalPages - 1) { %>
                      <span class="pagination-ellipsis">...</span>
                    <% } %>
                    <a href="/admin/users?page=<%= totalPages %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" class="pagination-number"><%= totalPages %></a>
                  <% } %>
              </div>
              
              <% if (hasNextPage) { %>
                <a href="/admin/users?page=<%= currentPageNum + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>" class="pagination-btn">Next →</a>
              <% } else { %>
                <span class="pagination-btn disabled">Next →</span>
              <% } %>
            </div>
          <% } %>
        <% } else { %>
          <div class="empty-state">
            <p><%= search ? 'No users found matching your search.' : 'No users found.' %></p>
          </div>
        <% } %>
      </div>
    </section>

    <script>
      // Handle delete user
      document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const email = this.getAttribute('data-email');
          const name = this.getAttribute('data-name');
          
          if (!confirm(`Are you sure you want to delete the user "${name}" (${email})? This action cannot be undone.`)) {
            return;
          }

          try {
            const response = await fetch(`/admin/users/${encodeURIComponent(email)}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });

            const result = await response.json();

            if (result.success) {
              alert('User deleted successfully!');
              window.location.reload();
            } else {
              alert('Error: ' + result.message);
            }
          } catch (error) {
            alert('Error deleting user: ' + error.message);
          }
        });
      });
    </script>

<%- include('../partials/footer') %>


<%- include('../partials/header') %>

    <!-- Page Hero -->
    <section class="page-hero compact">
      <div class="container">
        <p class="eyebrow">Admin</p>
        <h1>Donation <em>Records</em></h1>
        <p class="page-lead">Track and manage all donations to the organization.</p>
      </div>
    </section>

    <!-- Donations Section -->
    <section class="section">
      <div class="container">
        <!-- Search and Add -->
        <div class="donations-controls">
          <form method="GET" action="/donations" class="donations-search-form">
            <input 
              type="text" 
              name="search" 
              placeholder="Search by name, email, or amount..." 
              value="<%= searchTerm %>"
              class="search-input"
            >
            <button type="submit" class="btn btn-primary btn-sm">Search</button>
            <% if (searchTerm) { %>
              <a href="/donations" class="btn btn-outline btn-sm">Clear</a>
            <% } %>
          </form>
          <% if (user && user.role === 'manager') { %>
            <a href="/manage/donations/new" class="btn btn-primary">+ Record Donation</a>
          <% } %>
        </div>

        <!-- Stats Summary -->
        <div class="donations-stats">
          <div class="stat-card">
            <span class="stat-number">$<%= totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
            <span class="stat-label">Total Raised</span>
          </div>
          <div class="stat-card">
            <span class="stat-number"><%= totalDonations %></span>
            <span class="stat-label">Total Donations</span>
          </div>
          <% if (totalDonations > 0) { %>
          <div class="stat-card">
            <span class="stat-number">$<%= (totalAmount / totalDonations).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
            <span class="stat-label">Average Gift</span>
          </div>
          <% } %>
        </div>

        <!-- Success/Error Messages -->
        <% if (message) { %>
          <div class="alert alert-<%= messageType === 'success' ? 'success' : 'error' %>" style="margin-bottom: var(--space-xl);">
            <%= message %>
          </div>
        <% } %>

        <!-- Donations Table -->
        <% if (donations && donations.length > 0) { %>
          <div class="data-table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Donor</th>
                  <th>Amount</th>
                  <% if (user && user.role === 'manager') { %>
                    <th>Actions</th>
                  <% } %>
                </tr>
              </thead>
              <tbody>
                <% donations.forEach(donation => { %>
                  <tr>
                    <td><%= donation.donationDate && donation.donationDate !== 'UNKNOWN_DATE' ? new Date(donation.donationDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”' %></td>
                    <td>
                      <strong><%= donation.donorName %></strong>
                      <% if (donation.donorEmail) { %>
                        <br><small class="text-muted"><%= donation.donorEmail %></small>
                      <% } %>
                    </td>
                    <td class="amount-cell">$<%= donation.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                    <% if (user && user.role === 'manager') { %>
                      <td>
                        <div class="action-buttons">
                          <a href="/manage/donations/<%= donation.id %>/edit" class="btn btn-sm btn-outline">Edit</a>
                          <button class="btn btn-sm btn-danger delete-donation-btn" data-id="<%= donation.id %>">Delete</button>
                        </div>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <div class="pagination">
              <span class="pagination-info">
                Showing page <%= currentPageNum %> of <%= totalPages %> (<%= totalDonations %> total)
              </span>
              <div class="pagination-controls">
                <% if (hasPrevPage) { %>
                  <a href="/donations?page=<%= currentPageNum - 1 %><%= searchTerm ? '&search=' + encodeURIComponent(searchTerm) : '' %>" class="pagination-link">Previous</a>
                <% } else { %>
                  <span class="pagination-link disabled">Previous</span>
                <% } %>
                
                <% for (let i = Math.max(1, currentPageNum - 2); i <= Math.min(totalPages, currentPageNum + 2); i++) { %>
                  <% if (i === currentPageNum) { %>
                    <span class="pagination-link active"><%= i %></span>
                  <% } else { %>
                    <a href="/donations?page=<%= i %><%= searchTerm ? '&search=' + encodeURIComponent(searchTerm) : '' %>" class="pagination-link"><%= i %></a>
                  <% } %>
                <% } %>
                
                <% if (hasNextPage) { %>
                  <a href="/donations?page=<%= currentPageNum + 1 %><%= searchTerm ? '&search=' + encodeURIComponent(searchTerm) : '' %>" class="pagination-link">Next</a>
                <% } else { %>
                  <span class="pagination-link disabled">Next</span>
                <% } %>
              </div>
            </div>
          <% } %>
        <% } else { %>
          <div class="empty-state">
            <p><%= searchTerm ? 'No donations found matching your search.' : 'No donations recorded yet.' %></p>
            <% if (!searchTerm && user && user.role === 'manager') { %>
              <a href="/manage/donations/new" class="btn btn-primary">+ Record First Donation</a>
            <% } %>
          </div>
        <% } %>
      </div>
    </section>

    <style>
      .donations-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-xl);
        flex-wrap: wrap;
      }
      .donations-search-form {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        flex-wrap: wrap;
      }
      .donations-search-form .search-input {
        width: 280px;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
      }
      .donations-search-form .search-input:focus {
        outline: none;
        border-color: var(--salmon);
        box-shadow: 0 0 0 2px rgba(var(--salmon-rgb), 0.2);
      }
      .donations-stats {
        display: flex;
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
        flex-wrap: wrap;
      }
      .stat-card {
        background: var(--white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        padding: var(--space-md) var(--space-xl);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 140px;
      }
      .stat-card .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
      }
      .stat-card .stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .amount-cell {
        font-weight: 600;
        color: var(--success);
      }
      @media (max-width: 768px) {
        .donations-controls {
          flex-direction: column;
          align-items: stretch;
        }
        .donations-search-form {
          width: 100%;
        }
        .donations-search-form .search-input {
          flex: 1;
          width: auto;
        }
        .donations-stats {
          justify-content: center;
        }
      }
    </style>

    <script>
      // Handle delete donation button clicks
      document.querySelectorAll('.delete-donation-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const donationId = this.getAttribute('data-id');
          
          if (!confirm('Are you sure you want to delete this donation? This action cannot be undone.')) {
            return;
          }

          try {
            const response = await fetch(`/manage/donations/${donationId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });

            const result = await response.json();

            if (result.success) {
              window.location.reload();
            } else {
              alert('Error: ' + result.message);
            }
          } catch (error) {
            alert('Error: ' + error.message);
          }
        });
      });
    </script>

<%- include('../partials/footer') %>

<%- include('../partials/header') %>

<section class="page-hero compact">
  <div class="container">
    <p class="eyebrow">Admin / Event</p>
    <h1>Manage Transportation</h1>
    <% if (event) { %>
      <p class="page-lead">Coordinating rides for: <strong><%= event.title %></strong></p>
    <% } else { %>
      <p class="page-lead">Event not found.</p>
    <% } %>
  </div>
</section>

<section class="section">
  <div class="container">
    <div style="margin-bottom: 2rem;">
      <a href="/manage/events" class="btn btn-outline btn-sm">← Back to All Events</a>
    </div>

    <% if (event) { %>
      <!-- Matching UI -->
      <div class="match-maker-wrapper">
        <h3>Create a Match</h3>
        <form action="/admin/events/<%= event.detailId %>/match" method="POST" class="match-form">
          <div class="form-group">
            <label for="driver-select">Select a Driver</label>
            <select name="driverEmail" id="driver-select" required>
              <option value="">-- Choose a driver --</option>
              <% drivers.forEach(driver => { %>
                <option value="<%= driver.userEmail %>" 
                  <%= driver.availableSeats <= 0 ? 'disabled' : '' %>>
                  <%= driver.userName || driver.userEmail %> 
                  (<%= driver.availableSeats %>/<%= driver.seatCount %> seats available)
                </option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label for="rider-select">Select a Rider</label>
            <select name="riderEmail" id="rider-select" required>
              <option value="">-- Choose a rider --</option>
              <% if (riders.length > 0) { %>
                <% riders.forEach(rider => { %>
                  <option value="<%= rider.userEmail %>"><%= rider.userName || rider.userEmail %></option>
                <% }) %>
              <% } else { %>
                <option value="" disabled>No unmatched riders available</option>
              <% } %>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" <%= riders.length === 0 ? 'disabled' : '' %>>Create Match</button>
        </form>
        <% if (matchMessage) { %>
          <div class="match-message <%= matchSuccess ? 'success' : 'error' %>">
            <%= matchMessage %>
          </div>
        <% } %>
      </div>

      <!-- Existing Matches -->
      <% if (matches && matches.length > 0) { %>
        <div class="matches-section">
          <h3>Existing Matches (<%= matches.length %>)</h3>
          <div class="matches-list">
            <% matches.forEach(match => { %>
              <div class="match-card">
                <div class="match-info">
                  <strong><%= match.driverName %></strong>
                  <span class="match-arrow">→</span>
                  <strong><%= match.riderName %></strong>
                </div>
                <div class="match-meta">
                  Matched on <%= new Date(match.matchedAt).toLocaleDateString() %>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>

      <!-- Data Display Grid -->
      <div class="transport-grid">
        <!-- Drivers Column -->
        <div class="transport-column">
          <h4>Offering Rides (<%= drivers.length %>)</h4>
          <% if (drivers.length > 0) { %>
            <ul class="transport-list">
              <% drivers.forEach(driver => { %>
                <li class="transport-card">
                  <div class="card-main">
                    <span class="user-email"><%= driver.userName || driver.userEmail %></span>
                    <span class="seat-count <%= driver.availableSeats <= 0 ? 'seat-full' : '' %>">
                      <%= driver.availableSeats %>/<%= driver.seatCount %> seats
                    </span>
                  </div>
                  <div class="card-details">
                    <span>Radius: <%= driver.radius %> miles</span>
                    <span>From: <%= driver.address %></span>
                    <% if (driver.matchedCount > 0) { %>
                      <span class="matched-info">Matched with <%= driver.matchedCount %> rider<%= driver.matchedCount !== 1 ? 's' : '' %></span>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="empty-state">No drivers have offered rides yet.</p>
          <% } %>
        </div>

        <!-- Riders Column -->
        <div class="transport-column">
          <h4>Needing a Ride (<%= riders.length %> unmatched)</h4>
          <% if (riders.length > 0) { %>
            <ul class="transport-list">
              <% riders.forEach(rider => { %>
                <li class="transport-card">
                  <div class="card-main">
                    <span class="user-email"><%= rider.userName || rider.userEmail %></span>
                  </div>
                  <div class="card-details">
                    <span>From: <%= rider.address %></span>
                    <span>Phone: <%= rider.userPhone || 'Not provided' %></span>
                  </div>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="empty-state">
              <% if (typeof matches !== 'undefined' && matches.length > 0) { %>
                All riders have been matched!
              <% } else { %>
                No one has requested a carpool spot yet.
              <% } %>
            </p>
          <% } %>
        </div>
      </div>
    <% } %>
  </div>
</section>

<style>
  .match-maker-wrapper {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
  }
  .match-maker-wrapper h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
  }
  .match-form {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
  }
  .match-form .form-group {
    margin: 0;
  }
  .match-message {
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: var(--radius-md);
  }
  .match-message.success {
    background-color: #d4edda;
    color: #155724;
  }
  .match-message.error {
    background-color: #f8d7da;
    color: #721c24;
  }

  .transport-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }
  .transport-column h4 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--peach-light);
    padding-bottom: 0.5rem;
  }
  .transport-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .transport-card {
    background: var(--white);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    font-size: 0.9rem;
  }
  .card-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
  }
  .card-details {
    font-size: 0.8rem;
    color: var(--text-secondary);
    border-top: 1px solid var(--peach-light);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
  }
  .card-details span {
    display: block;
  }
  .user-email {
    font-weight: 600;
  }
  .seat-count {
    background: var(--peach-light);
    color: var(--coral);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 600;
  }
  .empty-state {
    background: var(--white);
    padding: 1rem;
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
  }
  
  .seat-count.seat-full {
    background: var(--danger-light);
    color: var(--danger);
  }
  
  .matched-info {
    color: var(--success);
    font-weight: 500;
    margin-top: 0.25rem;
  }
  
  .matches-section {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-top: 2rem;
  }
  
  .matches-section h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--peach-light);
    padding-bottom: 0.5rem;
  }
  
  .matches-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .match-card {
    background: var(--bg-light);
    padding: 1rem;
    border-radius: var(--radius-md);
    border-left: 3px solid var(--success);
  }
  
  .match-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }
  
  .match-arrow {
    color: var(--text-secondary);
    font-size: 1.2rem;
  }
  
  .match-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }
  
  @media (max-width: 768px) {
    .match-form {
      grid-template-columns: 1fr;
    }
    
    .transport-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<%- include('../partials/footer') %>
